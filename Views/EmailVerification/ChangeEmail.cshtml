@using Microsoft.AspNetCore.Http
@using System.Threading;
@using System.Globalization
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    Layout = "/Views/MasterPage.cshtml";

    var langIso = Thread.CurrentThread.CurrentCulture.TwoLetterISOLanguageName;
    langIso = langIso.Contains("en") ? "" : $"/{langIso}";
    var strButtonContinue = Umbraco.GetDictionaryValue("SIP - Continue Button ");
    var strAgree = Umbraco.GetDictionaryValue("SIP - Agree");

    var strChange = Umbraco.GetDictionaryValue("SIP - Page1 - Change");
    var strEmailPrompt = Umbraco.GetDictionaryValue("Input your email address", "Input your email address");
    var strEmailPlaceholder = Umbraco.GetDictionaryValue("Email", "Email");
    var strSuccess = Umbraco.GetDictionaryValue("Your email has been updated.", "Your email has been updated.");
    var strInvalidEmail = Umbraco.GetDictionaryValue("Please enter a valid email.", "Please enter a valid email.");
}

<div class="mt-12 ">
    <div class="flex flex-col items-center justify-center h-full w-full max-w-[740px]">
        <div class="flex flex-col justify-between items-center w-full gap-4 mb-8!">
            <div class="flex justify-between items-center w-full">
                <p class="str-email w-fit! mb-0! text-2xl md:text-3xl">@strEmailPrompt</p>
                <a target="_blank" href="@Umbraco.GetDictionaryValue("SIP - Page1 Need Help Url")" class="green-link" id="help_link_page1">@Umbraco.GetDictionaryValue("SIP - Need Help")</a>
            </div>
        </div>

        <form id="welcome" class="w-full flex flex-col items-center p-0!" onsubmit="return false;">
            <div class="w-full">
                <input id="email-input" name="email" type="email" autocomplete="email" placeholder="@strEmailPlaceholder" class="w-full bg-white text-black/90 rounded-md h-10 md:h-12 p-2" required />
            </div>

            <div id="email-feedback" class="mt-2 text-sm text-red-500 hidden"></div>
            <div id="email-success" class="mt-2 text-sm text-green-600 hidden"></div>

            <button id="but-cont" type="submit" form="welcome" class="playerclub-button-yellow py-2 text-black! font-semibold justify-center mt-6! cursor-pointer">
                @strButtonContinue
            </button>
        </form>

        <p class="agree_text mt-6!">
            @Html.Raw(strAgree)
        </p>
    </div>
</div>

<script>
    (function () {
        const form = document.getElementById('welcome');
        const emailInput = document.getElementById('email-input');
        const submitBtn = document.getElementById('but-cont');
        const feedback = document.getElementById('email-feedback');
        const success = document.getElementById('email-success');

        function show(el, message, isError) {
            if (!el) return;
            el.textContent = message || '';
            el.classList.toggle('hidden', !message);
            if (isError) {
                el.classList.add('text-red-500');
                el.classList.remove('text-green-600');
            } else {
                el.classList.add('text-green-600');
                el.classList.remove('text-red-500');
            }
        }

        function validateEmail(value) {
            // Simple RFC 5322-ish email validation
            return /[^\s@@]+@@[^\s@@]+\.[^\s@@]+/.test(value);
        }

        async function updateEmail(email) {
            try {
                const resp = await fetch('/api/User', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email })
                });

                const contentType = resp.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json') || contentType.includes('problem+json');
                const data = isJson ? await resp.json().catch(() => ({})) : {};

                if (resp.ok) {
                    window.location.href = '/email-verification';
                    return { ok: true, data };
                }

                const message = (data && (data.message || data.detail)) || 'Failed to update email.';
                return { ok: false, status: resp.status, message, data };
            } catch (e) {
                return { ok: false, status: 0, message: 'Network error. Please try again.' };
            }
        }

        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            show(feedback, '', true);
            show(success, '', false);

            const email = (emailInput?.value || '').trim();
            if (!validateEmail(email)) {
                show(feedback, '@strInvalidEmail', true);
                return;
            }

            submitBtn?.setAttribute('disabled', 'true');
            submitBtn?.classList.add('opacity-70', 'cursor-not-allowed');

            const result = await updateEmail(email);

            if (result.ok) {
                show(success, '@strSuccess', false);
                show(feedback, '', true);
                // Optionally, navigate back to verification result after success
                // window.location.href = '/email-verification';
            } else {
                const msg = result.message || 'Failed to update email.';
                show(feedback, msg, true);
            }

            submitBtn?.removeAttribute('disabled');
            submitBtn?.classList.remove('opacity-70', 'cursor-not-allowed');
        });
    })();
</script>