@using Umbraco.Cms.Web.Common.PublishedModels;
@using Newtonsoft.Json
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using System.Threading
@using System.Globalization
@{
    Layout = "MasterPage.cshtml";
    var langIso = Thread.CurrentThread.CurrentCulture.TwoLetterISOLanguageName;
    langIso = langIso.Contains("en") ? "" : $"/{langIso}";
}

@if (Context.Request.Query.TryGetValue("u", out var phoneQuery) && Context.Request.Query.TryGetValue("t", out var tokenQuery))
{
    var phone = phoneQuery.FirstOrDefault() ?? "";
    var token = tokenQuery.FirstOrDefault() ?? "";

    var strTitle = Umbraco.GetDictionaryOrDefault("SIP - Page0 - Set a new password", "Set a new password");
    var strNewPassword = Umbraco.GetDictionaryOrDefault("SIP - Page0 - Set a new password (New password)", "New password");
    var strConfirmPassword = Umbraco.GetDictionaryOrDefault("SIP - Confirm Password", "Confirm Password");
    var strPasswordMust = Umbraco.GetDictionaryValue("SIP - Page0 - Set a new password (Password must)");
    var strButtonChange = Umbraco.GetDictionaryValue("SIP - Page0 - Set a new password (Change)");
    var strNeedHelp = Umbraco.GetDictionaryValue("SIP - Need Help");
    var strNeedHelpUrl = Umbraco.GetDictionaryValue("SIP - Page0 Need Help Url");

    <link rel="stylesheet" href="/assets/shared/css/styles.css">
    <link rel="stylesheet" href="/assets/homepage/css/app-fonts.css">
    <link rel="stylesheet" href="/assets/homepage/css/app.css">

    <div class="page-wrap mt-6 sm:mt-20 px-4 sm:px-0">
        <div class="flex flex-col items-center justify-center h-full">
            <!-- Desktop title -->
            <span id="desktop-title" class="block text-4xl/12 text-center w-full hidden sm:flex justify-center">
                @strTitle
            </span>
            <!-- Mobile title -->
            <div id="mobile-title" class="flex flex-col w-full sm:hidden gap-2 mb-4">
                <p class="mb-0! text-2xl font-medium">
                    @strTitle
                </p>
                <a target="_blank" href="@strNeedHelpUrl" class="green-link text-sm self-end" id="help_link_mobile">
                    @strNeedHelp
                </a>
            </div>
            <div class="flex justify-center flex-col items-center my-4 sm:my-15 w-full max-w-[670px] gap-5">
                <a id="help_link_desktop" class="self-end green-link hidden sm:flex" href="@strNeedHelpUrl" target="_blank">
                    @strNeedHelp
                </a>

                <!-- New Password Input -->
                <div id="new-password-group" class="w-full">
                    <label class="block text-base sm:text-lg mb-2 text-gray-200">@strNewPassword</label>
                    <div class="flex items-center border border-gray-600 rounded-xl overflow-hidden w-full bg-white h-14 sm:h-16 transition-all focus-within:border-green-500 focus-within:ring-1 focus-within:ring-green-500">
                        <input required type="password" id="new_password"
                            class="flex-1 h-full px-4 py-3 outline-none text-gray-900 placeholder-gray-400 text-base sm:text-lg bg-transparent"
                            placeholder="••••••••" />
                        <button type="button" id="btnShowPassword1"
                            onclick="togglePasswordVisibility('new_password', 'btnShowPassword1')"
                            class="flex items-center justify-center px-4 text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6 icon-hidden" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.74,7.13 11.35,7 12,7Z" />
                            </svg>
                            <svg class="w-6 h-6 icon-shown hidden" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Confirm Password Input -->
                <div id="confirm-password-group" class="w-full">
                    <label class="block text-base sm:text-lg mb-2 text-gray-200">@strConfirmPassword</label>
                    <div class="flex items-center border border-gray-600 rounded-xl overflow-hidden w-full bg-white h-14 sm:h-16 transition-all focus-within:border-green-500 focus-within:ring-1 focus-within:ring-green-500">
                        <input required type="password" id="confirm_password"
                            class="flex-1 h-full px-4 py-3 outline-none text-gray-900 placeholder-gray-400 text-base sm:text-lg bg-transparent"
                            placeholder="••••••••" />
                        <button type="button" id="btnShowPassword2"
                            onclick="togglePasswordVisibility('confirm_password', 'btnShowPassword2')"
                            class="flex items-center justify-center px-4 text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6 icon-hidden" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.74,7.13 11.35,7 12,7Z" />
                            </svg>
                            <svg class="w-6 h-6 icon-shown hidden" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Password requirements hint -->
                <p id="password-requirements" class="text-xs sm:text-sm text-gray-400 w-full">@strPasswordMust</p>

                <!-- Validation message -->
                <div id="validation-group" style="display: flex; width: 100%">
                    <p id="form-valid" class="validation_message text-center!"
                        style="flex-basis: 100%; display: none; text-align: left"></p>
                </div>

                <!-- Success message -->
                <div id="success-message" class="w-full hidden">
                    <p class="text-green-600 text-center text-lg">@Umbraco.GetDictionaryOrDefault("Password changed successfully", "Password changed successfully")</p>
                </div>

                <button type="button" id="submit_change_password"
                    class="playerclub-button-yellow w-full! max-sm:max-w-none! py-3 sm:py-4 px-12! mt-2! cursor-pointer justify-center text-black! text-base sm:text-lg font-semibold rounded-xl">
                    @strButtonChange
                </button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="~/assets/js/FormScript.js?v=2"></script>

    <script>
        const phoneParam = @Html.Raw(JsonConvert.SerializeObject(phone));
        const tokenParam = @Html.Raw(JsonConvert.SerializeObject(token));

        function togglePasswordVisibility(inputId, btnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            const iconHidden = btn.querySelector('.icon-hidden');
            const iconShown = btn.querySelector('.icon-shown');

            if (input.type === 'password') {
                input.type = 'text';
                iconHidden.classList.add('hidden');
                iconShown.classList.remove('hidden');
            } else {
                input.type = 'password';
                iconHidden.classList.remove('hidden');
                iconShown.classList.add('hidden');
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("new_password").focus();
        });

        document.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("submit_change_password").click();
            }
        });

        document.getElementById("submit_change_password").addEventListener("click", async function () {
            const btn = this;
            const formErrorElem = document.getElementById("form-valid");
            const successMessage = document.getElementById("success-message");
            const newPasswordInput = document.getElementById("new_password");
            const confirmPasswordInput = document.getElementById("confirm_password");

            // Reset validation styles
            newPasswordInput.parentElement.classList.remove("border-red-500");
            confirmPasswordInput.parentElement.classList.remove("border-red-500");
            formErrorElem.style.display = "none";
            formErrorElem.textContent = "";

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Validate password length
            if (newPassword.length < 6) {
                formErrorElem.style.display = "block";
                formErrorElem.style.color = "red";
                formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("Password must be at least 6 characters","Password must be at least 6 characters"))";
                newPasswordInput.parentElement.classList.add("border-red-500");
                return;
            }

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                formErrorElem.style.display = "block";
                formErrorElem.style.color = "red";
                formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("Passwords do not match","Passwords do not match"))";
                confirmPasswordInput.parentElement.classList.add("border-red-500");
                return;
            }

            // Validate token is present
            if (!tokenParam) {
                formErrorElem.style.display = "block";
                formErrorElem.style.color = "red";
                formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("Invalid or expired reset link","Invalid or expired reset link"))";
                return;
            }

            btn.style.pointerEvents = "none";
            DisplayLoadingScreen();

            const iso = localStorage.getItem("Iso") || "";

            const body = {
                username: phoneParam.replace('+', ''),
                remindKind: 2, // Password reset with token
                countryIso: iso,
                token: tokenParam,
                newPassword: newPassword,
                language: iso
            };

            try {
                const resp = await fetch("/api/auth/forgot", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Fetch-Indicator": "true"
                    },
                    body: JSON.stringify(body)
                });

                const data = await resp.json().catch(() => ({}));

                if (resp.ok) {
                    // Hide form elements and show success message
                    document.getElementById("desktop-title").style.display = "none";
                    document.getElementById("mobile-title").style.display = "none";
                    document.getElementById("help_link_mobile").style.display = "none";
                    document.getElementById("help_link_desktop").style.display = "none";
                    document.getElementById("new-password-group").style.display = "none";
                    document.getElementById("confirm-password-group").style.display = "none";
                    document.getElementById("password-requirements").style.display = "none";
                    document.getElementById("validation-group").style.display = "none";
                    btn.style.display = "none";
                    successMessage.classList.remove("hidden");

                    // Redirect to sign-in page after delay
                    setTimeout(function () {
                        window.location.href = "@Html.Raw($"{langIso}/")";
                    }, 3000);
                } else {
                    formErrorElem.style.display = "block";
                    formErrorElem.style.color = "red";
                    if (data.code === "USER_NOT_FOUND") {
                        formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("User not found","User not found"))";
                    } else if (data.code === "INVALID_TOKEN") {
                        formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("Invalid or expired reset link","Invalid or expired reset link"))";
                    } else {
                        formErrorElem.textContent = data.detail || data.message || "@Html.Raw(Umbraco.GetDictionaryOrDefault("An error occurred","An error occurred"))";
                    }
                }
            } catch (err) {
                formErrorElem.style.display = "block";
                formErrorElem.style.color = "red";
                formErrorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryOrDefault("Network error","Network error"))";
            } finally {
                btn.style.pointerEvents = "initial";
                CloseLoadingScreen();
            }
        });
    </script>
}
else
{
    Context.Response.Redirect($"{langIso}/");
}