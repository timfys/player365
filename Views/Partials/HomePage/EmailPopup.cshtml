@* Email Verification Popup (Tailwind) *@
<div id="email-verify-popup"
  class="fixed flex inset-0 z-50 hidden items-center justify-center p-4 md:p-6 lg:p-8 bg-black/60 backdrop-blur-sm">
  <div class="relative w-full max-w-xl rounded-2xl border border-white/10 bg-[#022b32] shadow-2xl">
    <!-- Close button -->
    <button type="button"
      class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full border border-white/10 text-white/70 hover:text-white hover:border-white/20 hover:bg-white/5 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#0FA1B8]"
      aria-label="Close" data-close>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
        <path fill-rule="evenodd"
          d="M6.225 4.811a1 1 0 0 1 1.414 0L12 9.172l4.361-4.36a1 1 0 1 1 1.414 1.414L13.414 10.586l4.36 4.361a1 1 0 0 1-1.414 1.414L12 12l-4.361 4.361a1 1 0 1 1-1.414-1.414l4.36-4.361-4.36-4.361a1 1 0 0 1 0-1.414Z"
          clip-rule="evenodd" />
      </svg>
    </button>

    <div class="p-6 md:p-7 lg:p-8 space-y-6">
      <!-- Top row: text (flex-grow) + image (auto width) -->
      <div class="flex items-start gap-6">
        <!-- Left (text) -->
        <div class="flex-1 min-w-[200px]">
          <h2 class="text-xl font-bold leading-snug text-[#F3F8F8] md:text-2xl">
            Verify your email <span class="gold-gradient-text">& get 5 coins to start playing games</span>
          </h2>
          <p class="mt-2 text-sm leading-relaxed text-[#9EA4AE]">
            Confirm your email and instantly receive
            <span class="font-semibold text-white">$5 free credit</span>
            start playing at PlayerClub365. Verify now and jump into the action.
          </p>
        </div>

        <!-- Right (image) -->
        <div class="flex-shrink-0 flex justify-center items-start max-xs:hidden">
          <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 md:h-28 md:w-28 lg:h-32 lg:w-32">
            <rect x="8" y="18" width="64" height="44" rx="8" fill="#07363D" stroke="#0FA1B8" stroke-width="2" />
            <path d="M10 22l30 18L70 22" fill="none" stroke="#14b8a6" stroke-width="2" />
          </svg>
        </div>
      </div>

      <!-- Bottom row: full-width inputs and button -->
      <div>
        <label class="block text-xs font-medium text-[#9EA4AE]">Enter your email address</label>
        <div
          class="mt-2 flex items-center gap-2 rounded-md border border-white/10 bg-white px-3 py-2 focus-within:ring-2 focus-within:ring-[#0FA1B8]">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
            class="h-5 w-5 text-[#9EA4AE]">
            <path
              d="M1.5 7.5A2.25 2.25 0 0 1 3.75 5.25h16.5A2.25 2.25 0 0 1 22.5 7.5v9a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 16.5v-9Zm2.25-.75a.75.75 0 0 0-.75.75v.307l9 5.143 9-5.143V7.5a.75.75 0 0 0-.75-.75H3.75Zm17.25 3.13-8.57 4.897a.75.75 0 0 1-.76 0L3.09 9.88v6.62c0 .414.336.75.75.75h16.5a.75.75 0 0 0 .75-.75V9.88Z" />
          </svg>
          <input id="email-verify-input" type="email" autocomplete="email" placeholder="you@example.com"
            class="peer w-full bg-transparent text-sm text-[#101010] placeholder:text-[#161616] outline-none" />
        </div>

        <p id="email-verify-msg" class="mt-2 text-xs" role="status" aria-live="polite"></p>

        <button type="button" data-submit
          class="playerclub-button-yellow rounded-md font-semibold transition-colors text-black! no-underline! mt-4 inline-flex w-full items-center justify-center px-5 py-2 text-base shadow-md focus:outline-none focus-visible:ring-2">
          Approve my email address
        </button>

        <p data-note class="mt-3 text-xs text-[#9EA4AE]">
          We`ll send you a quick confirmation link so you can start playing right away.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const root = document.getElementById('email-verify-popup');
    if (!root) return;

    // ==== cookie helpers ====
    const SUPPRESS_COOKIE = 'email_verify_suppressed';
    function setCookie(name, value, days = 2) {
      const maxAge = Math.floor(days * 24 * 60 * 60);
      const secure = location.protocol === 'https:' ? '; Secure' : '';
      document.cookie =
        `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax${secure}`;
    }
    function getCookie(name) {
      const n = encodeURIComponent(name) + '=';
      return document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(n))?.slice(n.length) ?? null;
    }
    function isSuppressed() { return getCookie(SUPPRESS_COOKIE) === '1'; }
    function suppress(days = 2) { setCookie(SUPPRESS_COOKIE, '1', days); }

    const closeBtn = root.querySelector('[data-close]');
    const submitBtn = root.querySelector('[data-submit]');
    const input = root.querySelector('#email-verify-input');
    const labelEl = root.querySelector('[data-form-label]');
    const inputGroup = root.querySelector('[data-form-group]');
    const noteEl = root.querySelector('[data-note]');
    const msg = root.querySelector('#email-verify-msg');

    function setMsg(text, kind = 'info') {
      if (!msg) return;
      msg.textContent = text || '';
      msg.className = 'mt-2 text-xs ' + (
        kind === 'error' ? 'text-red-400' :
          kind === 'success' ? 'text-emerald-400' :
            'text-[#9EA4AE]'
      );
    }

    // NOTE: keep your regex if you prefer; this is just your original
    function validate(email) {
      return /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email);
    }

    // ---- API helpers
    async function fetchUser() {
      try {
        const res = await fetch('/api/user', { credentials: 'include' });
        if (!res.ok) return null;
        const data = await res.json();
        const api = data?.api || data;
        return {
          email: api?.email || api?.Email || api?.mail || api?.Mail || null,
          emailVerified: !!(api?.emailVerified ?? api?.EmailVerified ?? api?.isEmailVerified ?? api?.IsEmailVerified)
        };
      } catch { return null; }
    }

    async function updateEmail(email) {
      try {
        const res = await fetch('/api/user', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ Email: email })
        });
        if (res.ok) return true;
        const err = await res.json().catch(() => ({}));
        setMsg(err?.message || 'Failed to update email.', 'error');
        return false;
      } catch {
        setMsg('Network error while updating email.', 'error');
        return false;
      }
    }

    let currentUserEmail = null;
    function hide() { root.classList.add('hidden'); }
    async function show(prefill = null) {
      root.classList.remove('hidden');

      // reset state
      labelEl?.classList.remove('hidden!');
      inputGroup?.classList.remove('hidden!');
      submitBtn?.classList.remove('hidden!');
      noteEl?.classList.remove('hidden!');
      setMsg('');

      if (prefill) {
        input.value = prefill;
        currentUserEmail = prefill;
      } else {
        const user = await fetchUser();
        if (user?.email) input.value = user.email;
        currentUserEmail = user?.email ?? null;
      }
    }

    window.EmailVerifyPopup = { show, hide };

    function suppressAndHide() { suppress(2); hide(); }
    closeBtn?.addEventListener('click', suppressAndHide);
    root.addEventListener('click', (e) => { if (e.target === root) suppressAndHide(); });

    submitBtn?.addEventListener('click', async () => {
      const email = (input?.value || '').trim();

      window.dispatchEvent(new CustomEvent('email-verify:submit', { detail: { email } }));

      if (!validate(email)) {
        input?.focus();
        input?.classList.add('ring-2', 'ring-red-500/60');
        setTimeout(() => input?.classList.remove('ring-2', 'ring-red-500/60'), 900);
        setMsg('Please enter a valid email address.', 'error');
        return;
      }

      const isSameEmail = (currentUserEmail || '').toLowerCase() === email.toLowerCase();
      if (isSameEmail) {
        // No update needed; go to verification flow
        suppress(2);
        window.location.assign('/email-verification');
        return;
      }

      setMsg('Saving email…', 'info');
      submitBtn.disabled = true;
      const ok = await updateEmail(email);
      submitBtn.disabled = false;

      if (ok) {
        // don’t nag for 2 days; redirect to verification
        suppress(2);
        window.location.assign('/email-verification');
      }
    });

    input?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitBtn?.click();
      }
    });

    // ---- bootstrap logic
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) if cookie says suppressed, do nothing
      if (isSuppressed()) return;

      // 2) check server: if already verified, never show (also drop a long suppress cookie)
      const user = await fetchUser();
      if (user?.emailVerified) {
        suppress(30); // cache this for a while to avoid repeated API calls
        return;
      }

      // 3) otherwise show after 2s
      setTimeout(() => window.EmailVerifyPopup?.show(user?.email ?? null), 2000);
    });
  })();
</script>